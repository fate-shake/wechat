angular.module('myApp',['ngRoute']).controller('one',['$scope','$http','$timeout','publicData',function($scope,$http,$timeout,publicData){$scope.getJs=function(){var str,parastr;var array=[];$scope.array=[];str=location.href;parastr=str.split("?")[1];parastr=parastr.split("#")[0];var arr=parastr.split("&");for(var i=0;i<arr.length;i++){array[arr[i].split("=")[0]]=arr[i].split("=")[1];}if(array.token.lastIndexOf('#')>='0'){for(var j=0;j<=array.length;j++){$scope.array.token=array.token.split("#")[0];}}else{$scope.array=array;}return $scope.array;};$scope.getJs();Array.prototype.remove=function(dx){for(var i=0;i<this.length;i++){if(this[i]===dx){this.splice(i,1);}}};$('.affirm').bind('click',function(){$('.tips').hide();});}]).config(['$routeProvider',function($routeProvider){$routeProvider. when('/',{templateUrl:'./template/list.html',controller:'mainCtrl'}).when('/list/:id',{templateUrl:'./template/grouplist.html'}).when('/follow/:arg',{templateUrl:'./template/follow.html'}).when('/pBack/:arg',{templateUrl:'./template/playback.html'}).when('/manage/',{templateUrl:'./template/groupManage.html'}).when('/manage/:arg',{templateUrl:'./template/manage.html'}).when('/directive/:arg',{templateUrl:'./template/directive.html'}).when('/fencing/:arg',{templateUrl:'./template/fence.html'}).when('/add_device/',{templateUrl:'./template/add-device.html'})}]).controller('mainCtrl',['$scope','$http','$timeout','publicData',function($scope,$http,$timeout,publicData){$('#back')[0].style.display='none';$('#manage')[0].style.display='block';$('#directive')[0].style.display='none';$('#add').hide();$('#title')[0].innerText='车辆列表';$scope.total=[];$scope.live=[];var request={token:$scope.array.token,action:'carlist'};function getData(){if(publicData.total.length>0){$scope.mydata=publicData.total;console.log(0);for(var i=0;i<$scope.mydata.length;i++){var live=0;var total=0;for(var j=0;j<$scope.mydata[i].list.length;j++){if($scope.mydata[i].list[j].stt==1){live+=1;}}total=$scope.mydata[i].list.length;$scope.live.push(live);$scope.total.push(total);}}else{$http({method:'POST',url:"http://weixin.sky200.com/action.php",data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){if(data.errorcode=='0'){$scope.datas=data;$scope.getLive($scope.datas);getData();}else{$('#errorCode')[0].innerText=obj[data.errorcode];$('.tips').show();}}).error(function(){});}};$scope.getLive=function(data){var mydata=[];for(var i=0;i<data.data.g_size;i++){var eachGroup={};var live=0;var g_name='g_idx_'+i;var list=[];for(var j=0;j<data.data.g_list[g_name].d_size;j++){var d_name='d_idx_'+j;var device={};if(data.data.g_list[g_name].d_list[d_name].did!='0000000000'){device.GpsS=data.data.g_list[g_name].d_list[d_name].GpsS;device.GpsT=data.data.g_list[g_name].d_list[d_name].GpsT;device.SrvT=data.data.g_list[g_name].d_list[d_name].SrvT;device.b_lat=data.data.g_list[g_name].d_list[d_name].b_lat;device.b_lng=data.data.g_list[g_name].d_list[d_name].b_lng;device.did=data.data.g_list[g_name].d_list[d_name].did;device.drct=data.data.g_list[g_name].d_list[d_name].drct;device.end=data.data.g_list[g_name].d_list[d_name].end;device.g_lat=data.data.g_list[g_name].d_list[d_name].g_lat;device.g_lng=data.data.g_list[g_name].d_list[d_name].g_lng;device.mdl=data.data.g_list[g_name].d_list[d_name].mdl;device.mval=data.data.g_list[g_name].d_list[d_name].mval;device.mname=data.data.g_list[g_name].d_list[d_name].mname;device.name=data.data.g_list[g_name].d_list[d_name].name;device.pic=data.data.g_list[g_name].d_list[d_name].pic;device.pms=data.data.g_list[g_name].d_list[d_name].pms;device.ptc=data.data.g_list[g_name].d_list[d_name].ptc;device.spd=data.data.g_list[g_name].d_list[d_name].spd;device.stt=data.data.g_list[g_name].d_list[d_name].stt;device.t_lgn=data.data.g_list[g_name].d_list[d_name].t_lgn;device.t_vld=data.data.g_list[g_name].d_list[d_name].t_vld;list.push(device);}}eachGroup.name=data.data.g_list[g_name].g_name;eachGroup.list=list;mydata.push(eachGroup);publicData.setData(mydata);}};getData();}]).controller('g_l_group',['$scope','$routeParams','publicData',function($scope,$routeParams,publicData){$scope.mydata=publicData.total;$scope.live=[];$scope.total=[];for(var i=0;i<$scope.mydata.length;i++){var live=0;for(var j=0;j<$scope.mydata[i].list.length;j++){if($scope.mydata[i].list[j].stt==1){live+=1;}}$scope.live.push(live);$scope.total.push($scope.mydata[i].list.length);}$scope.part_two_1=[];$scope.part_two_0=[];$scope.id=$routeParams.id;$scope.part_one=$scope.mydata.slice(0,parseInt($scope.id));$scope.part_one_0=$scope.mydata.slice(0,parseInt($scope.id));$scope.part_two=$scope.mydata[$scope.id].list;for(var i=0;i<$scope.part_two.length;i++){if($scope.part_two[i].stt=='1'){$scope.part_two_1.push($scope.part_two[i]);}else{$scope.part_two_0.push($scope.part_two[i]);}}$scope.part_three=$scope.mydata.slice(parseInt($scope.id)+1);$scope.index=parseInt($scope.id);publicData.setTemp($scope.mydata[$scope.id]);}]).controller('follow',['$scope','$http','$routeParams','$timeout',function($scope,$http,$routeParams,$timeout){$('#back')[0].style.display='block';$('#manage')[0].style.display='none';$('#directive')[0].style.display='block';$('#dir-back')[0].style.display='none';var imei=$routeParams.arg.split('&&')[0];var dname=$routeParams.arg.split('&&')[1];var dtype=$routeParams.arg.split('&&')[2];$('#title')[0].innerText=dname;$('#map').css({width:document.documentElement.clientWidth,height:document.documentElement.clientHeight-50});$('#f-panorama').css({width:document.documentElement.clientWidth,height:document.documentElement.clientHeight-50});$scope.map=new BMap.Map('map');var point=new BMap.Point(113.946532,22.561115);$scope.map.centerAndZoom(point,14);var opts={type:BMAP_NAVIGATION_CONTROL_SMALL};$scope.map.addControl(new BMap.NavigationControl(opts));var bottom_left_control=new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT,offset:new BMap.Size(70,2)});$scope.map.addControl(bottom_left_control);var request={action:'tracking',imei:imei,token:$scope.array.token};$scope.data=function(){$http({method:'POST',url:"http://weixin.sky200.com/action.php",data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){var data=data;if(data.errorcode=='0'){$('#directive').attr('href','#/directive/'+imei+'&&'+dname+'&&'+data.blng+'&&'+data.blat+'&&'+dtype);$('#f_p').attr('href','#/pBack/'+imei+'&&'+dname);$scope.forPano=data;if(!$scope.marker_new){$scope.myMarker();if(data.blng==0){$scope.marker_new.setPosition(new BMap.Point(data.lbs_blng,data.lbs_blat));$scope.map.panTo(new BMap.Point(data.lbs_blng,data.lbs_blat));}else{$scope.marker_new.setPosition(new BMap.Point(data.blng,data.blat));$scope.map.panTo(new BMap.Point(data.blng,data.blat));}}else{if(data.blng==0){$scope.marker_new.setPosition(new BMap.Point(data.lbs_blng,data.lbs_blat));$scope.map.panTo(new BMap.Point(data.lbs_blng,data.lbs_blat));}else{$scope.marker_new.setPosition(new BMap.Point(data.blng,data.blat));$scope.map.panTo(new BMap.Point(data.blng,data.blat));}if($scope.map.getBounds().containsPoint(new BMap.Point(data.blng,data.blat))==false||$scope.map.getBounds().containsPoint(new BMap.Point(data.lbs_blng,data.lbs_blat))==false){$scope.map.panTo(new BMap.Point(data.blng||data.lbs_blng,data.blat||data.lbs_blat));}}$scope.p1.innerHTML="时间："+$scope.dateChange(Date.parse(new Date((data.lasttime).replace(/-/g,"/")))+28800000);if(data.speed==0){$scope.p2.innerHTML='状态：基站定位';}else{$scope.p2.innerHTML="速度："+data.speed/10+'&nbsp;&nbsp;&nbsp;&nbsp;公里/小时';}}else{$('#errorCode')[0].innerText=obj[data.errorcode];$('.tips').show();}}).error(function(){});$scope.followTimer=$timeout(function(){$scope.data();},10000);};$scope.data();$scope.dateChange=function(date){var date=new Date(date);Y=date.getFullYear()+'-';M=(date.getMonth()+1<10?'0'+(date.getMonth()+1):date.getMonth()+1)+'-';D=(date.getDate()<10?'0'+(date.getDate()):date.getDate())+' ';h=(date.getHours()<10?'0'+(date.getHours()):date.getHours())+':';m=(date.getMinutes()<10?'0'+(date.getMinutes()):date.getMinutes())+':';s=(date.getSeconds()<10?'0'+(date.getSeconds()):date.getSeconds());return date=(Y+M+D+h+m+s);};$scope.myMarker=function(){function Marker(latlng){this.point=latlng;$scope.map.addOverlay(this);}Marker.prototype=new BMap.Overlay();Marker.prototype.initialize=function(latlng){var div=this.div=document.createElement("div");div.style.position="absolute";div.style.backgroundColor="rgba(255, 255, 255, 0)";div.style.border="0px solid #BC3B3A";div.style.borderRadius="5px";div.style.color="white";div.style.width="160px";div.style.height="80px";div.style.lineHeight="12px";div.style.whiteSpace="nowrap";div.style.MozUserSelect="none";div.style.fontSize="12px";var div2=document.createElement("div");div2.style.height="50px";div2.style.padding='5px 5px';div2.style.borderRadius="5px";div2.style.color='#129edf';div2.style.background="rgba(255, 255, 255, 0.8)";div2.style.border="1px solid #d3d3d3";div2.style.visibility='visible';div.appendChild(div2);$scope.p1=document.createElement("p");$scope.p1.style.margin='5px 0';$scope.p2=this_p2=document.createElement("p");div2.appendChild($scope.p1);div2.appendChild($scope.p2);$scope.p1.innerHTML="时间：";$scope.p2.innerHTML="速度：";var Icon=document.createElement("div");var Iconfont=document.createElement("div");Icon.style.borderRadius="5px";Icon.appendChild(Iconfont);Icon.style.background="rgba(255, 255, 255, 0)";Icon.style.position="absolute";Icon.style.width="160px";Icon.style.height="31px";Iconfont.style.marginLeft="auto";Iconfont.style.marginRight="auto";Iconfont.style.background="rgba(255, 255, 255, 0)";Iconfont.style.width="28px";Iconfont.style.height="28px";Iconfont.style.lineHeight="28px";Iconfont.style.fontSize="28px";var img=document.createElement("img");Iconfont.appendChild(img);img.style.height="31px";img.style.width="23px";img.style.display='block';img.src="./img/dev.png";Icon.style.overflow="hidden";div.appendChild(Icon);Icon.addEventListener('click',function(){if(div2.style.visibility=='hidden'){div2.style.visibility='visible';}else{div2.style.visibility='hidden';}});$scope.map.getPanes().labelPane.appendChild(div);return div;};Marker.prototype.draw=function(){var pixel=$scope.map.pointToOverlayPixel(this.point);this.div.style.left=pixel.x-80+"px";this.div.style.top=pixel.y-80+"px";};Marker.prototype.setPosition=function(latlng){this.point=latlng;var pixel=$scope.map.pointToOverlayPixel(latlng);this.div.style.left=pixel.x-80+"px";this.div.style.top=pixel.y-80+"px";};$scope.marker_new=new Marker(new BMap.Point(113.946532,22.561098));};$('.pano').bind('click',function(){if($scope.panorama){var position=new BMap.Point($scope.forPano.blng,$scope.forPano.blat);var PanoramaService=new BMap.PanoramaService();PanoramaService.getPanoramaByLocation(position,function(data){if(data==null){$('#errorCode')[0].innerText='该位置暂无全景数据';$('.tips').show();}else{$scope.panorama.setPosition(position);$('.panorama').css('visibility','visible');$('.panorama').css('z-index','3');}})}else{$scope.panorama=new BMap.Panorama('f-panorama');var position=new BMap.Point($scope.forPano.blng,$scope.forPano.blat);var PanoramaService=new BMap.PanoramaService();PanoramaService.getPanoramaByLocation(position,function(data){if(data==null){$('#errorCode')[0].innerText='该位置暂无全景数据';$('.tips').show();}else{$scope.panorama.setPosition(position);$('.panorama').css('visibility','visible');$('.panorama').css('z-index','3');}});}});$('.closePano').bind('click',function(){$('.panorama').css('visibility','hidden');$('.panorama').css('z-index','-1');});$('#directive').bind('click',function(){$timeout.cancel($scope.followTimer);});$('#f_p').bind('click',function(){$timeout.cancel($scope.followTimer);});$('#back').bind('click',function(){speed=0;$timeout.cancel($scope.followTimer);$timeout.cancel($scope.playTimer);});}]).controller('pBack',['$scope','$http','$routeParams','$timeout','playback',function($scope,$http,$routeParams,$timeout,playback){var name=$routeParams.arg.split('&&')[1];$('.secList').css('height',document.documentElement.clientHeight-50);$('.list').css('height',document.documentElement.clientHeight-50);$('#title')[0].innerText=name+'(回放)';$('#pBackMap').css({width:document.documentElement.clientWidth,height:document.documentElement.clientHeight-50});$scope.map1=new BMap.Map('pBackMap');$scope.myGeo=new BMap.Geocoder();var point=new BMap.Point(113.946532,22.561115);$scope.map1.centerAndZoom(point,14);var opts={type:BMAP_NAVIGATION_CONTROL_SMALL};$scope.map1.addControl(new BMap.NavigationControl(opts));var bottom_left_control=new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT,offset:new BMap.Size(70,2)});$scope.map1.addControl(bottom_left_control);$('#back')[0].style.display='block';$('#directive').hide();$timeout.cancel($scope.followTimer);$('#manage')[0].style.display='none';$scope.getData=function(ST,ET){$('.load').show();var imei=$routeParams.arg.split('&&')[0];var request={action:'playblack',token:$scope.array.token,imei:imei,st:ST,et:ET};$http({method:'POST',url:"http://weixin.sky200.com/action.php",data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();$scope.map1.clearOverlays();if(data.errorcode=='0'){$scope.data_get=data;$scope.pbData=playback.filter(data);if($scope.pbData.usefulldata==undefined||$scope.pbData.usefulldata.length==0){$('#errorCode')[0].innerText='回放暂无数据！';$('.tips').show();}else{$scope.drawPolyLine($scope.pbData.usefulldata);$scope.drawMarker();var myIcon1=new BMap.Icon('img/startIcon.png',new BMap.Size(45,90));var marker1=new BMap.Marker(new BMap.Point($scope.pbData.usefulldata[0].b_lng,$scope.pbData.usefulldata[0].b_lat),{icon:myIcon1});$scope.map1.addOverlay(marker1);var myIcon2=new BMap.Icon('img/endIcon.png',new BMap.Size(45,90));var marker2=new BMap.Marker(new BMap.Point($scope.pbData.usefulldata[$scope.pbData.usefulldata.length-1].b_lng,$scope.pbData.usefulldata[$scope.pbData.usefulldata.length-1].b_lat),{icon:myIcon2});$scope.map1.addOverlay(marker2);$('.secList').css({'display':'block','right':'0'});$('.date').css('top','-100%');}}else{$('#errorCode')[0].innerText=obj[data.errorcode];$('.tips').show();}}).error(function(){})};$scope.drawMarker=function(){function Marker(latlng){this._point=latlng;$scope.map1.addOverlay(this);}Marker.prototype=new BMap.Overlay();Marker.prototype.initialize=function(){var div=this._div=document.createElement("div");div.style.position="absolute";div.style.backgroundColor="rgba(255, 255, 255, 0)";div.style.border="0px solid #BC3B3A";div.style.borderRadius="5px";div.style.color="#129edf";div.style.width="160px";div.style.height="81px";div.style.lineHeight="12px";div.style.whiteSpace="nowrap";div.style.MozUserSelect="none";div.style.fontSize="12px";var div2=document.createElement("div");div2.style.height="48px";div2.style.borderRadius="5px";div2.style.padding='5px 5px';div2.style.background="rgba(255,255,255, 0.8)";div2.style.border="1px solid #d3d3d3";div.appendChild(div2);$scope.p1=this_p1=document.createElement("p");$scope.p1.style.margin='5px 0';$scope.p2=this_p2=document.createElement("p");div2.appendChild($scope.p1);div2.appendChild($scope.p2);div2.style.visibility='visible';$scope.p1.innerHTML="时间："+$scope.pbData.usefulldata[0].GpsT;$scope.p2.innerHTML="速度："+$scope.pbData.usefulldata[0].spd;var Icon=document.createElement("div");var Iconfont=document.createElement("div");Icon.style.borderRadius="5px";Icon.appendChild(Iconfont);Icon.style.background="rgba(255, 255, 255, 0)";Icon.style.position="absolute";Icon.style.width="160px";Icon.style.height="31px";Iconfont.style.marginLeft="auto";Iconfont.style.marginRight="auto";Iconfont.style.background="rgba(255, 255, 255, 0)";Iconfont.style.width="28px";Iconfont.style.height="31px";Iconfont.style.lineHeight="28px";Iconfont.style.fontSize="28px";var img=document.createElement("img");Iconfont.appendChild(img);img.style.height="31px";img.style.width="23px";img.style.display='block';img.src="./img/dev.png";Icon.style.overflow="hidden";div.appendChild(Icon);Icon.addEventListener('click',function(){if(div2.style.visibility=='hidden'){div2.style.visibility='visible';}else{div2.style.visibility='hidden';}});$scope.map1.getPanes().labelPane.appendChild(div);return div;};Marker.prototype.draw=function(){var pixel=$scope.map1.pointToOverlayPixel(this._point);this._div.style.left=pixel.x-80+"px";this._div.style.top=pixel.y-78+"px";};Marker.prototype.setPosition=function(latlng){this._point=latlng;var pixel=$scope.map1.pointToOverlayPixel(latlng);this._div.style.left=pixel.x-80+"px";this._div.style.top=pixel.y-78+"px";};$scope.marker_new=new Marker(new BMap.Point($scope.pbData.usefulldata[0].b_lng,$scope.pbData.usefulldata[0].b_lat));};$scope.reset=function(){$scope.i=0;};window.playHere=function(){var slider=$('#slider')[0].value;if($scope.polyData){$scope.i=parseInt(slider);$scope.p1.innerHTML="时间："+$scope.polyData[$scope.i].GpsT;if($scope.polyData[$scope.i].GpsS=='L'||$scope.polyData[$scope.i].GpsS=='B'||$scope.polyData[$scope.i].GpsS=='W'){var gps='';if($scope.polyData[$scope.i].GpsS=='L'||$scope.polyData[$scope.i].GpsS=='B'){gps='基站定位';}else{gps='WiFi定位';}$scope.p2.innerHTML="定位方式："+gps;}else{$scope.p2.innerHTML="速度："+$scope.polyData[$scope.i].spd/10+'&nbsp;&nbsp;&nbsp;&nbsp;公里/小时';}$scope.nowTime=$scope.polyData[$scope.i].GpsT;$scope.marker_new.setPosition(new BMap.Point($scope.polyData[$scope.i].b_lng,$scope.polyData[$scope.i].b_lat));if($scope.map1.getBounds().containsPoint(new BMap.Point($scope.polyData[$scope.i].b_lng+0.2,$scope.polyData[$scope.i].b_lat+0.2))==false){$scope.map1.panTo(new BMap.Point($scope.polyData[$scope.i].b_lng,$scope.polyData[$scope.i].b_lat));}}};playBack=function(){var total=$scope.polyData.length;if(speed==0){speed=2;}if($scope.i==undefined){$scope.i=0;}$scope.siliby=$scope.i;if($scope.i<$scope.polyData.length){$scope.p1.innerHTML="时间："+$scope.polyData[$scope.i].GpsT;if($scope.polyData[$scope.i].GpsS=='L'||$scope.polyData[$scope.i].GpsS=='B'||$scope.polyData[$scope.i].GpsS=='W'){var gps='';if($scope.polyData[$scope.i].GpsS=='L'||$scope.polyData[$scope.i].GpsS=='B'){gps='基站定位';}else{gps='WiFi定位';}$scope.p2.innerHTML="定位方式："+gps;}else{$scope.p2.innerHTML="速度："+$scope.polyData[$scope.i].spd/10+'&nbsp;&nbsp;&nbsp;&nbsp;公里/小时';}$scope.nowTime=$scope.polyData[$scope.i].GpsT;$scope.marker_new.setPosition(new BMap.Point($scope.polyData[$scope.i].b_lng,$scope.polyData[$scope.i].b_lat));if($scope.map1.getBounds().containsPoint(new BMap.Point($scope.polyData[$scope.i].b_lng+0.2,$scope.polyData[$scope.i].b_lat+0.2))==false){$scope.map1.panTo(new BMap.Point($scope.polyData[$scope.i].b_lng,$scope.polyData[$scope.i].b_lat));}}if($scope.i<$scope.polyData.length){if($('#slider')[0]){$('#slider')[0].value=$scope.i;$scope.i++;}else{play=false;}}if($scope.i>=$scope.polyData.length){$('#playIcon').attr('src','./img/play.png');$('#speedIcon').attr('src','./img/slow.png');speed=0;}if(speed==0){}else{if(play){$scope.playTimer=$timeout(function(){playBack();},(speed/2)*1000);}else{}}};$scope.drawPolyLine=function(data){$scope.polyData=data;var polyline=new BMap.Polyline([new BMap.Point($scope.polyData[0].b_lng,$scope.polyData[0].b_lat)],{strokeColor:"blue",strokeWeight:1,strokeOpacity:1});$scope.path=[];var polyPoint=[];for(var j=0;j<$scope.polyData.length;j++){polyPoint.push(new BMap.Point($scope.polyData[j].b_lng,$scope.polyData[j].b_lat));}$scope.polyline=new BMap.Polyline(polyPoint,{strokeColor:"#0fb2ff",strokeWeight:3,strokeOpacity:1});$scope.map1.addOverlay($scope.polyline);};function listMsg(){$scope.listMsg=[];var T_runTime=0,T_stayTime=0,T_distance=0;for(var i=0;i<$scope.pbData.secData.length;i++){var msg=[];var runTime=timeCycle(Date.parse($scope.breakPoint[i][1].replace(/-/g,"/"))-Date.parse($scope.breakPoint[i][0].replace(/-/g,"/")));T_runTime+=(Date.parse($scope.breakPoint[i][1].replace(/-/g,"/"))-Date.parse($scope.breakPoint[i][0].replace(/-/g,"/")));if(i+1<$scope.breakPoint.length){var stayTime=timeCycle(Date.parse($scope.breakPoint[i+1][0].replace(/-/g,"/"))-Date.parse($scope.breakPoint[i][1].replace(/-/g,"/")));T_stayTime+=(Date.parse($scope.breakPoint[i+1][0].replace(/-/g,"/"))-Date.parse($scope.breakPoint[i][1].replace(/-/g,"/")));}else{var stayTime='0秒';T_stayTime+=0;}var sec=$scope.breakData($scope.breakPoint[i][0].replace(/-/g,"/"),$scope.breakPoint[i][1].replace(/-/g,"/"));var Distance=0;for(var j=0;j<sec.length-1;j++){var dis=getDistance(sec[j].b_lat,sec[j].b_lng,sec[j+1].b_lat,sec[j+1].b_lng);Distance+=dis;}T_distance+=Distance;var aveSpeed=Distance/((Date.parse($scope.breakPoint[i][1].replace(/-/g,"/"))-Date.parse($scope.breakPoint[i][0].replace(/-/g,"/")))/1000);msg.push(dateChange(Date.parse($scope.breakPoint[i][0].replace(/-/g,"/"))+28800000),dateChange(Date.parse($scope.breakPoint[i][1].replace(/-/g,"/"))+28800000),runTime,stayTime,Distance/1000,aveSpeed);$scope.listMsg.push(msg);};$scope.drvingTime=timeCycle(T_runTime);$scope.stayTime=timeCycle(T_stayTime);$scope.mileage=T_distance/1000;$scope.aveSpeed=T_distance/(T_runTime/1000)*3.6;};function getDistance(lat1,lng1,lat2,lng2){var dValueLat=(lat1>lat2)?(lat1-lat2):(lat2-lat1);var dValueLng=(lng1>lng2)?(lng1-lng2):(lng2-lng1);if((0.0000001>dValueLat)&&(0.0000001>dValueLng)){return 0.0;}lng1*=Math.PI/180.0;lat1*=Math.PI/180.0;lng2*=Math.PI/180.0;lat2*=Math.PI/180.0;var sDistance=Math.acos(Math.cos(lat1-lat2)-Math.cos(lat1)*Math.cos(lat2)*(1-Math.cos(lng1-lng2)));sDistance+=sDistance*6378137.0;return sDistance;};function timeCycle(msd){if(msd!=0){var time=parseFloat(msd)/1000;if(null!=time&&""!=time){if(time>=60&&time<60*60){time=parseInt(time/60.0)+"分钟"+parseInt((parseFloat(time/60.0)-parseInt(time/60.0))*60)+"秒";}else if(time>=60*60&&time<60*60*24){time=parseInt(time/3600.0)+"小时"+parseInt((parseFloat(time/3600.0)-parseInt(time/3600.0))*60)+"分钟"+parseInt((parseFloat((parseFloat(time/3600.0)-parseInt(time/3600.0))*60)-parseInt((parseFloat(time/3600.0)-parseInt(time/3600.0))*60))*60)+"秒";}else if(time>0&&time<60){time=parseInt(time)+"秒";}else{time=parseInt(time/86400.0)+"天"+parseInt((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)+"小时"+parseInt(((parseFloat((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)-parseInt((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)))*60)+"分钟"+parseInt((parseFloat(((parseFloat((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)-parseInt((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)))*60)-parseInt(((parseFloat((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)-parseInt((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)))*60))*60)+"秒";}}}else{time=0+'秒';}return time;};$(function(){var currYear=(new Date()).getFullYear();var opt={};var dateMin=new Date();dateMin.setMonth(dateMin.getMonth()-3);opt.date={preset:'datetime'};opt.datetime={preset:'datetime',minDate:dateMin,maxDate:new Date(),stepMinute:5};opt.time={preset:'time'};opt.default={theme:'android-ics light',display:'modal',mode:'scroller',lang:'zh',startYear:currYear,endYear:currYear};$("#appDateTime0").mobiscroll($.extend(opt['date'],opt['default']));$("#appDateTime1").mobiscroll($.extend(opt['date'],opt['default']));});$('.secList').bind('click',function(){$('.secList').css({'right':'-100%','display':'none'});});$('#list').bind('click',function(){if(!$scope.data_get){$('.express').css('left','0%');}else{$('.secList').css({'display':'block','right':'0'});}});$('#speed').bind('click',function(){if(speed==0){}else if(speed==2){$('#speedIcon').attr('src','./img/quick.png');speed=1;}else{speed=2;$('#speedIcon').attr('src','./img/slow.png');}});$('.list').bind('click',function(){return false;});listen=function(){var select=$('#chooseTime option:selected').text();if(select=='自定义'){$('.express').css('left','-100%');$('#expressForm')[0].reset();$('.date').css('top','25%');var now=new Date();$('#appDateTime0')[0].value=dateChange(now-7200000);$('#appDateTime1')[0].value=dateChange(now);}};dateChange=function(date){var date=new Date(date);Y=date.getFullYear()+'-';M=(date.getMonth()+1<10?'0'+(date.getMonth()+1):date.getMonth()+1)+'-';D=(date.getDate()<10?'0'+(date.getDate()):date.getDate())+' ';h=(date.getHours()<10?'0'+(date.getHours()):date.getHours())+':';m=(date.getMinutes()<10?'0'+(date.getMinutes()):date.getMinutes())+':';s=(date.getSeconds()<10?'0'+(date.getSeconds()):date.getSeconds());return date=(Y+M+D+h+m+s);};$('#choose').bind('click',function(){$('.express').css('left','0');});$('.cancel0').bind('click',function(){$('.date').css('top','-100%');$('#detailTime')[0].reset();});$('.cancel1').bind('click',function(){$('.express').css('left','-100%');$('#expressForm')[0].reset();});$('#expressDate').bind('click',function(){var st=0,et=0;var now=new Date();var today_zero=now-now.getHours()*3600000-now.getMinutes()*60000-now.getSeconds()*1000;var yes_zero=now-86400000-now.getHours()*3600000-now.getMinutes()*60000-now.getSeconds()*1000;var qian_zero=yes_zero-86400000;var select=$('#chooseTime option:selected').text();if(select=='今天'){st=dateChange(today_zero-28800000);et=dateChange(now-28800000);}else if(select=='昨天'){st=dateChange(yes_zero-28800000);et=dateChange(today_zero-1000-28800000)}else if(select=='前天'){st=dateChange(qian_zero-28800000);et=dateChange(yes_zero-1000-28800000)}$('.express').css('left','-100%');$scope.getData(st,et);});$('#detailDate').bind('click',function(){var st=$('#appDateTime0')[0].value,et=$('#appDateTime1')[0].value;if(st!=''&&et!=''&&Date.parse(st)<Date.parse(et)){$('.date').css('top','-100%');$scope.getData(dateChange(Date.parse(st)-28800000),dateChange(Date.parse(et)-28800000));}});$('.total').bind('click',function(){$timeout.cancel($scope.playTimer);$('.secList').css({'right':'-100%','display':'none'});$('#playIcon').attr('src','./img/stop.png');$scope.backData=$scope.pbData.usefulldata;$scope.map1.clearOverlays();$scope.drawPolyLine($scope.backData);$scope.drawMarker();var myIcon1=new BMap.Icon('img/startIcon.png',new BMap.Size(45,90));var marker1=new BMap.Marker(new BMap.Point($scope.backData[0].b_lng,$scope.backData[0].b_lat),{icon:myIcon1});$scope.map1.addOverlay(marker1);var myIcon2=new BMap.Icon('img/endIcon.png',new BMap.Size(45,90));var marker2=new BMap.Marker(new BMap.Point($scope.backData[$scope.backData.length-1].b_lng,$scope.backData[$scope.backData.length-1].b_lat),{icon:myIcon2});$scope.map1.addOverlay(marker2);$scope.reset();play=true;speed=0;$scope.siliby=0;playBack();$('#speedIcon').attr('src','./img/slow.png');})}]).controller('myGroup',['$scope','$http','publicData',function($scope,$http,publicData){$scope.mydata=publicData.total;$('#back')[0].style.display='block';$('#manage')[0].style.display='none';$('#dback')[0].style.display='none';$('#title')[0].innerText='设备管理';$('#add').show();$('#adddev').hide();$('.re-gName').bind('click',function(){var old_gName=$(this).attr('data-gname');var new_gName=$('#newGname')[0].value;if(new_gName!=''){var request={action:'grouprename',token:$scope.array.token,gname:old_gName,ngroup:new_gName};$http({method:'POST',url:"http://weixin.sky200.com/action.php",data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.new-group').hide();$('#newGname')[0].value='';if(data.errorcode=='0'){$('.tips').show();$('#errorCode')[0].innerText='修改成功！';for(var i=0;i<$scope.mydata.length;i++){if($scope.mydata[i].name==old_gName){$scope.mydata[i].name=new_gName;}}publicData.setData($scope.mydata);}else{$('#errorCode')[0].innerText=obj[data.errorcode];}})}else{}});$('.unChange').bind('click',function(){$('.new-group').hide();$('#newGname')[0].value='';});$('#add').bind('click',function(){$('.add-group').show();});$('.found').bind('click',function(){var gname=$('#addGname')[0].value;if(gname!=''){$('.add-group').hide();var request={gname:gname,token:$scope.array.token,action:'groupadd'};$http({method:'POST',url:"http://weixin.sky200.com/action.php",data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){if(data.errorcode=='0'){$('#errorCode')[0].innerText='创建成功！';var newGroup={'name':gname,'list':{}};$scope.mydata.push(newGroup);publicData.setData($scope.mydata);}else{$('#errorCode')[0].innerText=obj[data.errorcode];}$('.tips').show();}).error(function(){$('#errorCode')[0].innerText='服务器连接失败';$('.tips').show();})}});$('.unfound').bind('click',function(){$('.add-group').hide();});$('.delete').bind('click',function(){$('.delete-group').hide();var gname=$(this).attr('data-gname');var request={action:'groupdel',token:$scope.array.token,gname:gname};$http({method:'POST',url:"http://weixin.sky200.com/action.php",data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){if(data.errorcode=='0'){$('#errorCode')[0].innerText='删除成功！';for(var i=0;i<$scope.mydata.length;i++){if($scope.mydata[i].name==gname){$scope.mydata.remove($scope.mydata[i]);}}publicData.setData($scope.mydata);}else{$('#errorCode')[0].innerText=obj[data.errorcode];}$('.tips').show();}).error(function(){$('#errorCode')[0].innerText='网络连接失败，请检查网络';$('.tips').show();})});$('.undelete').bind('click',function(){$('.delete-group').hide();})}]).controller('manage',['$scope','$http','$routeParams','publicData',function($scope,$http,$routeParams,publicData){$scope.mydata=publicData.total;$('#back')[0].style.display='none';$('#dback')[0].style.display='block';$('#directive')[0].style.display='none';$('#add').hide();$('#adddev').show();$('#add-back').hide();$('#add-back').attr('href',location.href);$scope.id=parseInt($routeParams.arg);$('.cancel').bind('click',function(){$('.move').hide();});$('.re-close').bind('click',function(){$('.rename-device').hide();});$('.moveDevice').bind('click',function(){var checked=$('.choose');var nName=$('#groupName option:selected').text();var imei=[];for(var i=0;i<checked.length;i++){var device={};if(checked[i].checked==true){var did=$(checked[i]).attr('data-imei');var old=$(checked[i]).attr('data-old');device.did=did;device.old=old;imei.push(device);}}var request={token:$scope.array.token,action:'devmov',imei:imei,ngroup:nName,count:imei.length};$('.move').hide();$http({method:'POST',url:"http://weixin.sky200.com/action.php",data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){if(data.errorcode=='0'){$('#errorCode')[0].innerText='移动成功';var tempArray=[];for(var i=0;i<imei.length;i++){for(var j=0;j<$scope.mydata[$scope.id].list.length;j++){if($scope.mydata[$scope.id].list[j].did==imei[i].did){tempArray.push($scope.mydata[$scope.id].list[j]);}}}for(var i=0;i<imei.length;i++){for(var j=0;j<$scope.mydata[$scope.id].list.length;j++){if($scope.mydata[$scope.id].list[j].did==imei[i].did){$scope.mydata[$scope.id].list.remove($scope.mydata[$scope.id].list[j]);}}}for(var i=0;i<$scope.mydata.length;i++){if($scope.mydata[i].name==nName){for(var j=0;j<imei.length;j++){if($scope.mydata[i].list.length){$scope.mydata[i].list.push(tempArray[j]);}else{$scope.mydata[i].list=[];$scope.mydata[i].list.push(tempArray[j]);}}}}publicData.setData($scope.mydata);}else{$('#errorCode')[0].innerText=obj[data.errorcode];}$('.tips').show();})});$('.moveIt').bind('click',function(){var checked=$('.choose');var len=0;for(var i=0;i<checked.length;i++){if(checked[i].checked==true){len=len+1;}}if(len>0){$('.move').show();}});$('.choose-all').bind('click',function(){var checked=$('.choose');for(var i=0;i<checked.length;i++){checked[i].checked=true;}});$('.reverse').bind('click',function(){var checked=$('.choose');for(var i=0;i<checked.length;i++){if(checked[i].checked==true){checked[i].checked=false;}else{checked[i].checked=true;}}});$('.unselect').bind('click',function(){var checked=$('.choose');for(var i=0;i<checked.length;i++){checked[i].checked=false;}});$('.re-name').bind('click',function(){var newName=$('#newName')[0].value;if(newName==''){}else{$('.rename-device').hide();var did=$(this).attr('data-did');var request={imei:did,token:$scope.array.token,name:newName,action:'devrename'};$http({method:'POST',url:"http://weixin.sky200.com/action.php",data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){if(data.errorcode=='0'){$('#errorCode')[0].innerText='修改成功！';$('.tips').show();for(var i=0;i<$scope.mydata[$scope.id].list.length;i++){if($scope.mydata[$scope.id].list[i].did==did){$scope.mydata[$scope.id].list[i].name=newName;}}publicData.setData($scope.mydata);}else{}})}})}]).controller('addDevice',['$scope','$http',function($scope,$http){$('#adddev').hide();$('#add-back').show();$('#submit-btn').bind('click',function(){$('.load').show();var imei=$('#imei')[0].value;var key=$('#key')[0].value;var request={action:'devadd',token:$scope.array.token,imei:imei,key:key};$http({method:'POST',url:"http://weixin.sky200.com/action.php",data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();if(data.errorcode=='0'){$('#errorCode')[0].innerText='添加成功！';}else{$('#errorCode')[0].innerText=obj[data.errorcode];}$('.tips').show();}).error(function(){$('.load').hide();$('#errorCode')[0].innerText='网络连接失败，请检查网络';$('.tips').show();})})}]).controller('directive',['$scope','$http','$routeParams','publicData','$timeout',function($scope,$http,$routeParams,publicData,$timeout){$('#manage')[0].style.display='none';$('#back')[0].style.display='none';$('#directive')[0].style.display='none';$('#dir-back')[0].style.display='block';$scope.imei=$routeParams.arg.split('&&')[0];var dname=$routeParams.arg.split('&&')[1],lng=$routeParams.arg.split('&&')[2],lat=$routeParams.arg.split('&&')[3];$scope.dtype=$routeParams.arg.split('&&')[4];$('#dir-back').attr('href','#/follow/'+$scope.imei+'&&'+dname);$('#fencing').attr('href','#/fencing/'+$scope.imei+'&&'+dname+'&&'+lng+'&&'+lat+'&&'+$scope.dtype);$('#title')[0].innerText=dname;queryDirective=function(arg){var order='';if(arg=='中心号码'){order='CENTER?';}else if(arg=='SOS号码'){order='SOS?'}else if(arg=='监听号码'){$('.load').hide();}else if(arg=='速度报警'){order='SPEED?';}else if(arg=='工作模式'){order='SAVING?';}else if(arg=='震动报警'){order='MOTION?';}else if(arg=='断油电'){order='RELAY?';};var request={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:order};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(request),timeout:30000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){var arr=data.val,arr1=arr.replace(/[\r\n]/g,""),arr2=arr1.split('&');if(arr2[0]=='0'){var arr3=arr2[2].split(':');if(arr3[0]=='CENTER'){$('#center')[0].value=arr3[1];}else if(arr3[0]=='SOS'){var sos=arr3[1].split(',');$('#sos1')[0].value=sos[0];$('#sos2')[0].value=sos[1];$('#sos3')[0].value=sos[2];}else if(arr3[0]=='SPEED'){var speed=arr3[1].split(',');$('#lowSpeed')[0].value=speed[0];$('#overSpeed')[0].value=speed[1];}else if(arr3[0]=='RELAY'){if(arr3[1]=='ON'){$('#energy')[0].options[0].selected=true;}else{$('#energy')[0].options[1].selected=true;}}else if(arr3[0]=='MOTION'){var lv=arr3[1].split(',');$('#shakeLv')[0].options[lv[0]-1].selected=true;$('#shakeTime')[0].value=lv[1];}else if(arr3[0]=='SAVING'){$('#saving')[0].options[arr3[1]].selected=true;}$('.load').hide();}else{if(arr2[0]=='1'){$('#errorCode')[0].innerText='连接服务器超时';}else if(arr2[0]=='2'){$('#errorCode')[0].innerText='设备忙碌中，请稍后再次操作';}else{$('#errorCode')[0].innerText='未知错误，请重新尝试^_^!';}$('.tips').show();$('.load').hide();}}).error(function(){$('#errorCode')[0].innerText='连接服务器超时';$('.tips').show();$('.load').hide();})};var tempDev={};var tempGroup=publicData.tempGroup;for(var i=0;i<tempGroup.list.length;i++){if(tempGroup.list[i].did==$scope.imei){tempDev=tempGroup.list[i];}};$scope.saving=true;$scope.fence=(tempDev.mval.efc==0)?false:true;$scope.energy=(tempDev.mval.oil==0)?false:true;$scope.sos=(tempDev.mval.sos==0)?false:true;$scope.listen=(tempDev.mval.lst==0)?false:true;$scope.speed=(tempDev.mval.spd==0)?false:true;$scope.shake=(tempDev.mval.vib==0)?false:true;}]).controller('fence',['$scope','$http','$routeParams','$timeout',function($scope,$http,$routeParams,$timeout){$('.load').show();$('#fence-map').css('height',document.documentElement.clientHeight-50);$scope.fence_map=new BMap.Map('fence-map');var point=new BMap.Point(113.946532,22.561115);$scope.fence_map.centerAndZoom(point,14);$scope.maxRadius=5000;$scope.minRadius=100;$scope.step=100;var opts={type:BMAP_NAVIGATION_CONTROL_SMALL};$scope.fence_map.addControl(new BMap.NavigationControl(opts));var bottom_left_control=new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT,offset:new BMap.Size(70,2)});$scope.fence_map.addControl(bottom_left_control);function pantoCenter(opt){$scope.fence_map.clearOverlays();$scope.Circle=new BMap.Circle(opt,$scope.radius);$scope.Circle.setStrokeWeight(1);$scope.Circle.setStrokeColor('blue');$scope.fence_map.addOverlay($scope.Circle);var p1=$scope.Circle.getBounds().getNorthEast();var p2=$scope.Circle.getBounds().getSouthWest();var mapRight=$scope.fence_map.getBounds().getNorthEast();var mapLeft=$scope.fence_map.getBounds().getSouthWest();if(p1!=null){$scope.fence_map.setViewport([opt,p1,p2]);}};$scope.fence_map.addEventListener('moveend',function(){if($scope.Circle){$scope.center=$scope.fence_map.getCenter();$scope.fence_map.clearOverlays();$scope.Circle=new BMap.Circle($scope.center,$scope.radius);$scope.Circle.setStrokeWeight(1);$scope.Circle.setStrokeColor('blue');$scope.fence_map.addOverlay($scope.Circle);}});$scope.fence_map.addEventListener('zoomend',function(){if($scope.Circle){$scope.center=$scope.fence_map.getCenter();$scope.fence_map.clearOverlays();$scope.Circle=new BMap.Circle($scope.center,$scope.radius);$scope.Circle.setStrokeWeight(1);$scope.Circle.setStrokeColor('blue');$scope.fence_map.addOverlay($scope.Circle);}});function ZoomControl(){this.defaultAnchor=BMAP_ANCHOR_TOP_LEFT;this.defaultOffset=new BMap.Size(0,0);};ZoomControl.prototype=new BMap.Control();ZoomControl.prototype.initialize=function(map){var div=document.createElement("div");div.style.width="100%";div.style.height="100%";div.style.border="1px solid gray";div.style.position="absolute";div.style.pointerEvents="none";div.className='fence_circle';map.getContainer().appendChild(div);return div;};var myZoomCtrl=new ZoomControl();$scope.fence_map.addControl(myZoomCtrl);var imei=$routeParams.arg.split('&&')[0],dname=$routeParams.arg.split('&&')[1],lng=$routeParams.arg.split('&&')[2],lat=$routeParams.arg.split('&&')[3],dtype=$routeParams.arg.split('&&')[4];$('#title')[0].innerText=dname+'(围栏)';$scope.center=point;$scope.radius=300;$scope.Circle=new BMap.Circle($scope.center,$scope.radius);$scope.Circle.setStrokeWeight(1);$scope.Circle.setStrokeColor('blue');$scope.fence_map.addOverlay($scope.Circle);function seftMarker(){$scope.myIcon=new BMap.Icon("./img/fenceDev.png",new BMap.Size(21,30),{anchor:new BMap.Size(11,30)});$scope.marker=new BMap.Marker(new BMap.Point(lng,lat),{icon:$scope.myIcon});$scope.fence_map.setZoom(17);$scope.fence_map.addOverlay($scope.marker);}seftMarker();$scope.myIcon1=new BMap.Icon("./img/radius.png",new BMap.Size(64,64),{anchor:new BMap.Size(32,64)});queryFence(1);function drawFence(id,shape,p1,p2){$('#fenceMessage')[0].innerText='当前围栏编号：'+id;if(shape=='S'){var request={dtype:dtype,action:'cmd',cmdnum:9,imei:imei,token:$scope.array.token,cmdvalue:'FENCE'+','+id+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){console.log('删除矩形围栏成功');}).error(function(){});$('#fenceMessage')[0].innerText='设备暂时未设置围栏';}else{if(p2!=0){$scope.center=new BMap.Point(p1.lng,p1.lat);$scope.radius=(parseFloat(p2)>5000)?5000:parseFloat(p2);$('#radius-slider')[0].value=$scope.radius;$scope.Circle.setCenter($scope.center);$scope.Circle.setRadius($scope.radius);$scope.Circle.setStrokeWeight(1);$scope.fence_map.addOverlay($scope.Circle);$scope.shape='R';$scope.fence_map.panTo($scope.center);}else{$('#fenceMessage')[0].innerText='设备暂时未设置围栏';$scope.center=new BMap.Point(lng,lat);$scope.radius=300;$('#radius-slider')[0].value=$scope.radius;$scope.Circle.setCenter($scope.center);$scope.Circle.setRadius($scope.radius);$scope.Circle.setStrokeWeight(1);$scope.fence_map.addOverlay($scope.Circle);$scope.fence_map.panTo($scope.center);$scope.shape='R';}}};function setFence(type,shape,id){$('.load').show();var request={dtype:dtype,action:'cmd',cmdnum:9,imei:imei,token:$scope.array.token,cmdvalue:'FENCE'+','+id+','+type+'R'+','+$scope.center.lng+','+$scope.center.lat+','+$scope.radius+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(request),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();if(data.errorcode=='0'){$('.tips').show();$('#errorCode')[0].innerText='设置成功！';}else{$('.tips').show();$('#errorCode')[0].innerText='设置失败！';}})};function queryFence(id){var id=id;var request={dtype:dtype,action:'cmd',cmdnum:9,imei:imei,token:$scope.array.token,cmdvalue:'FENCE,'+id+'?'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var arr=data.val.replace(/[\r\n]/g,"").split('&');if(arr[0]=='0'){var arr1=arr[2].split(':')[1].split(',');if(arr1.length==4){drawFence(id,'R',new BMap.Point(arr1[1],arr1[2]),arr1[3])}else if(arr1.length==5){drawFence(id,'S',new BMap.Point(arr1[1],arr1[2]),new BMap.Point(arr1[3],arr1[4]))}else{seftMarker();$('#fenceMessage')[0].innerText='设备暂时未设置围栏';$scope.center=new BMap.Point(lng,lat);$scope.radius=300;$('#radius-slider')[0].value=$scope.radius;$scope.Circle.setCenter($scope.center);$scope.Circle.setRadius($scope.radius);$scope.Circle.setStrokeWeight(1);$scope.fence_map.addOverlay($scope.Circle);$scope.fence_map.panTo($scope.center);$scope.shape='R';var p1=$scope.Circle.getBounds().getNorthEast();var p2=$scope.Circle.getBounds().getSouthWest();var mapRight=$scope.fence_map.getBounds().getNorthEast();var mapLeft=$scope.fence_map.getBounds().getSouthWest();if(p1.lng>=mapRight.lng||p2.lng<=mapLeft.lng){$scope.fence_map.setViewport([$scope.center,p1,p2]);}}}else if(arr[0]=='1'){$('.tips').show();$('#errorCode')[0].innerText='网络连接超时，请重新打开页面';}else if(arr[0]=='2'){$('.tips').show();$('#errorCode')[0].innerText='设备正在被占用，请稍后重试';}else if(arr[0]=='3'){$('.tips').show();$('#errorCode')[0].innerText='数据库连接失败';}else{$('.tips').show();$('#errorCode')[0].innerText='设备繁忙';}})}function delFence(id){$('.load').show();var request={dtype:dtype,action:'cmd',cmdnum:9,imei:imei,token:$scope.array.token,cmdvalue:'FENCE'+','+id+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(request),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('.tips').show();$('#errorCode')[0].innerText='删除成功！';}else{$('.tips').show();$('#errorCode')[0].innerText='删除失败！';}}).error(function(){})};$scope.dimes=[5000,10000,50000,100000,250000,500000];$scope.dime=5000;$scope.$watch('dime',function(newval,oldval){if($scope.radius>newval){$scope.radius=newval;pantoCenter($scope.center);}});$scope.setRadius=function(opt){var slider=$('#radius-slider')[0];if(opt=='-'){switch($scope.dime){case 5000:$scope.radius=($scope.radius>=100)?($scope.radius-100):0;break;case 10000:$scope.radius=($scope.radius>=1000)?($scope.radius-1000):0;break;case 50000:$scope.radius=($scope.radius>5000)?($scope.radius-5000):0;break;case 100000:$scope.radius=($scope.radius>10000)?($scope.radius-10000):0;break;case 250000:$scope.radius=($scope.radius>20000)?($scope.radius-20000):0;break;case 500000:$scope.radius=($scope.radius>50000)?($scope.radius-50000):0;break;}}else{switch($scope.dime){case 5000:$scope.radius=($scope.radius<4900)?($scope.radius+100):5000;break;case 10000:$scope.radius=($scope.radius<9900)?($scope.radius+1000):10000;break;case 50000:$scope.radius=($scope.radius<45000)?($scope.radius+5000):50000;break;case 100000:$scope.radius=($scope.radius<90000)?($scope.radius+10000):100000;break;case 250000:$scope.radius=($scope.radius<230000)?($scope.radius+20000):250000;break;case 500000:$scope.radius=($scope.radius<450000)?($scope.radius+50000):500000;break;}}slider.value=$scope.radius;pantoCenter($scope.center);};$('#radius-slider').change(function(){$scope.radius=this.value;$scope.Circle.setRadius($scope.radius);var p1=$scope.Circle.getBounds().getNorthEast();var p2=$scope.Circle.getBounds().getSouthWest();$scope.fence_map.setViewport([$scope.center,p1,p2]);$scope.$apply();});window.sliderTouch=function(){var slider=$('#radius-slider')[0].value;$scope.radius=slider;pantoCenter($scope.center);$scope.$apply();};$('.fence-radius-wrap').bind('click',function(event){event.stopPropagation();});$('.setFC').bind('click',function(){if($('.argument')[0].style.display=='none'){$('.argument').show();}else{$('.argument').hide();}});$('#query1').bind('click',function(){$('.load').show();queryFence(1);});$('#query2').bind('click',function(){$('.load').show();queryFence(2);});$('#query3').bind('click',function(){$('.load').show();queryFence(3);});$('#setFence').bind('click',function(){var type=$('#type option:selected').text(),index=$('#index option:selected').text();var t='',s='',i='';if(type=='超出'){t='O';}else if(type=='跨越'){t='C';}else{t='I';}s='R';if(index=='围栏一'){i=1;}else if(index=='围栏二'){i=2;}else{i=3;}setFence(t,s,i);});$('.delFC').bind('click',function(){var id=this.id;delFence(id);});change=function(){var shape=$('#shape option:selected').text();var p1=$scope.marker1.getPosition(),p2=$scope.marker2.getPosition();if(shape=='矩形'){shape='S';}else{shape='R';}if($scope.shape!=shape){drawFence('',shape,p1,p2);}}}]).directive('delFence',function(){return{restrict:'A',link:function($scope,element){element.bind('click',function(){$('.warning').show();})}}}).directive('subsection',['$timeout',function($timeout){return{restrict:'A',link:function($scope,element){element.bind('click',function(){$timeout.cancel($scope.playTimer);speed=0;$scope.siliby=0;play=true;$('#playIcon').attr('src','./img/play.png');$('#speedIcon').attr('src','./img/slow.png');$('.secList').css({'right':'-100%','display':'none'});var index=parseInt($(this)[0].id);var myPoly=$scope.pbData.section[index];$scope.backData=$scope.pbData.section[index];Array.prototype.clone=function(){return this.slice(0);};var polydata=[];polydata=myPoly.clone();$scope.map1.clearOverlays();$scope.drawPolyLine(polydata);$scope.drawMarker();$scope.marker_new.setPosition(new BMap.Point(polydata[0].b_lng,polydata[0].b_lat));$scope.p1.innerHTML="时间："+polydata[0].GpsT;$scope.p2.innerHTML="速度："+polydata[0].spd/10+'&nbsp;&nbsp;&nbsp;&nbsp;公里/小时';$scope.map1.panTo(new BMap.Point(polydata[0].b_lng,polydata[0].b_lat));var myIcon1=new BMap.Icon('img/startIcon.png',new BMap.Size(45,90));var marker1=new BMap.Marker(new BMap.Point(polydata[0].b_lng,polydata[0].b_lat),{icon:myIcon1});$scope.map1.addOverlay(marker1);var myIcon2=new BMap.Icon('img/endIcon.png',new BMap.Size(45,90));var marker2=new BMap.Marker(new BMap.Point(polydata[$scope.polyData.length-1].b_lng,polydata[$scope.polyData.length-1].b_lat),{icon:myIcon2});$scope.map1.addOverlay(marker2);$scope.reset();playBack();})}}}]).directive('play',function($timeout){return{restrict:'A',link:function($scope,element){element.bind('click',function(){if($scope.i==undefined){if(!$scope.data_get){$('.express').css('left','0%');}else{$('#playIcon').attr('src','./img/stop.png');$scope.polyData=$scope.pbData.usefulldata;$scope.reset();speed=2;playBack();$('#speedIcon').attr('src','./img/slow.png');}}else if($scope.i==$scope.polyData.length){$('#playIcon').attr('src','./img/stop.png');$scope.reset();play=true;speed=2;playBack();$('#speedIcon').attr('src','./img/slow.png');}else if($scope.i==0){$('#playIcon').attr('src','./img/stop.png');play=true;speed=2;playBack();$('#speedIcon').attr('src','./img/slow.png');}else if(speed==0){$('#playIcon').attr('src','./img/stop.png');play=true;speed=2;playBack();$('#speedIcon').attr('src','./img/slow.png');}else{$('#playIcon').attr('src','./img/play.png');speed=0;$timeout.cancel($scope.playTimer);$('#speedIcon').attr('src','./img/slow.png');}})}}}).directive('isHide',function(){return{restrict:'C',link:function($scope,element){element.bind('click',function(){if($(this).next()[0].style.display=='none'){$('.load').show();$(this).next().show();var other=$(this).parent().siblings();for(var i=1;i<other.length-1;i++){other[i].children[1].style.display='none';}var txt=$(this).children().children()[0].innerText;queryDirective(txt);}else{$(this).next().hide();}})}}}).directive('addListenTel',['$http',function($http){return{restrict:"C",link:function($scope,element){element.bind('click',function(){$('.load').show();var listenTel=$('#listen').val();if(listenTel!=''){var listen={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:'LISTEN,'+listenTel+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(listen),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#errorCode')[0].innerText='设置成功！';}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='操作失败！';}$('.tips').show();}).error(function(){console.log('(*^__^*) 嘻嘻……');})}else{console.log('傻逼，填个字都不会吗~~~');}})}}}]).directive('addCenterTel',['$http',function($http){return{restrict:"C",link:function($scope,element){element.bind('click',function(){$('.load').show();var tel=$('#center').val();if(tel!=''){var center={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:'CENTER,'+'A,'+tel+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(center),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#errorCode')[0].innerText='设置成功！';}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='操作失败！';}$('.tips').show();}).error(function(){console.log('(*^__^*) 嘻嘻……');})}else{console.log('傻逼，填个字都不会吗~~~');}})}}}]).directive('delCenterTel',['$http',function($http){return{restrict:'C',link:function($scope,element){element.bind('click',function(){$('.load').show();var tel=$('#center').val();if(tel!=''){center={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:'CENTER,'+'D,'+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(center),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#errorCode')[0].innerText='删除成功！';$('#center').val('');}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='操作失败！';}$('.tips').show();}).error(function(){console.log('(*^__^*) 嘻嘻……');})}else{console.log('傻逼，填个字都不会吗~~~');}})}}}]).directive('addSpeedCtrl',['$http',function($http){return{restrict:'C',link:function($scope,element){element.bind('click',function(){$('.load').show();var overSpeed=$('#overSpeed').val();var lowSpeed=$('#lowSpeed').val();if(parseInt(overSpeed)>=parseInt(lowSpeed)){var speed={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:'SPEED,'+lowSpeed+','+overSpeed+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(speed),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#errorCode')[0].innerText='设置成功！';}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='数据库连接失败！';}$('.tips').show();})}else{}})}}}]).directive('delSpeedCtrl',['$http',function($http){return{restrict:'C',link:function($scope,element){element.bind('click',function(){$('.load').show();var speed={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:'SPEED,0,0#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(speed),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#overSpeed').val('');$('#lowSpeed').val('');$('#errorCode')[0].innerText='删除成功！';}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='操作失败！';}$('.tips').show();}).error(function(){})});}}}]).directive('energy',['$http',function($http){return{restrict:'C',link:function($scope,element){element.bind('click',function(){$('.load').show();var energy=$('#energy option:selected').text();$scope.set='';if(energy=='恢复油电'){$scope.set='1';}else{$scope.set='0';}var Energy={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:'RELAY,'+$scope.set+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(Energy),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#errorCode')[0].innerText='设置成功！';}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='操作失败！';}$('.tips').show();}).error(function(){})})}}}]).directive('saving',['$http',function($http){return{restrict:'C',link:function($scope,element){element.bind('click',function(){$('.load').show();var saving=$('#saving').val();if(saving=='long'){var save=0;}else if(saving=='power'){var save=1;}else if(saving=='sleep'){var save=2;}else{var save=3;}var query={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:'SAVING,'+save+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(query),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#errorCode')[0].innerText='设置成功！';}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='操作失败！';}$('.tips').show();}).error(function(){console.log('(*^__^*) 嘻嘻……');})})}}}]).directive('shake',['$http',function($http){return{restrict:'C',link:function($scope,element){element.bind('click',function(){$('.load').show();var shakeLv=$('#shakeLv').val();var shakeTime=$('#shakeTime').val();if(shakeTime==''||shakeTime>60||shakeTime<=0){console.log('请按照提示输入正确的数字！！！');}else{var query={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:'MOTION,'+shakeLv+','+shakeTime+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(query),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#errorCode')[0].innerText='设置成功！';}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='操作失败！';}$('.tips').show();}).error(function(){$('.load').hide();$('#errorCode')[0].innerText='连接失败，请检查网络！';$('.tips').show();})}})}}}]).directive('delShake',['$http',function($http){return{restrict:'C',link:function($scope,element){element.bind('click',function(){$('.load').show();var query={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:'MOTION,0,0#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(query),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#shakeLv').val('1');$('#shakeTime').val('');$('#errorCode')[0].innerText='删除成功！';}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='操作失败！';}$('.tips').show();}).error(function(){$('.load').hide();$('#errorCode')[0].innerText='连接失败，请检查网络！';console.log('(*^__^*) 嘻嘻……');})})}}}]).directive('addsosTel',['$http',function($http){return{restrict:'C',link:function($scope,element){element.bind('click',function(){$('.load').show();var sos1=$('#sos1')[0].value;var sos2=$('#sos2')[0].value;var sos3=$('#sos3')[0].value;var query={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:'SOS,A,'+sos1+','+sos2+','+sos3+'#'};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(query),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#errorCode')[0].innerText='添加成功！';}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='连接服务器失败！';}$('.tips').show();}).error(function(){$('.load').hide();$('#errorCode')[0].innerText='连接失败，请检查网络！';})})}}}]).directive('delsosTel',['$http',function($http){return{restrict:'C',link:function($scope,element){element.bind('click',function(){$('.loading').show();if($('#ckb1')[0].checked==true&&$('#ckb2')[0].checked==false&&$('#ckb3')[0].checked==false){var directive='SOS,D,1#';}else if($('#ckb1')[0].checked==false&&$('#ckb2')[0].checked==true&&$('#ckb3')[0].checked==false){var directive='SOS,D,2#';}else if($('#ckb1')[0].checked==false&&$('#ckb2')[0].checked==false&&$('#ckb3')[0].checked==true){var directive='SOS,D,3#';}else if($('#ckb1')[0].checked==true&&$('#ckb2')[0].checked==true&&$('#ckb3')[0].checked==false){var directive='SOS,D,1,2#';}else if($('#ckb1')[0].checked==true&&$('#ckb2')[0].checked==false&&$('#ckb3')[0].checked==true){var directive='SOS,D,1,3#';}else if($('#ckb1')[0].checked==false&&$('#ckb2')[0].checked==true&&$('#ckb3')[0].checked==true){var directive='SOS,D,2,3#';}else{var directive='SOS,D,1,2,3#';}var query={dtype:$scope.dtype,action:'cmd',cmdnum:9,imei:$scope.imei,token:$scope.array.token,cmdvalue:directive};$http({method:'POST',url:'http://weixin.sky200.com/action.php',data:$.param(query),timeout:300000,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){$('.load').hide();var realdata=data.val;var real=realdata.replace(/[\r\n]/g,"");var splitdata=real.split("&");if(splitdata[0]=='0'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='1'){$('#errorCode')[0].innerText='连接超时！';}else if(splitdata[0]=='2'){$('#errorCode')[0].innerText='设备已被占用，请稍后再操作！';}else{$('#errorCode')[0].innerText='操作失败！';}$('.tips').show();}).error(function(){$('.load').hide();$('#errorCode')[0].innerText='连接失败，请检查网络！';$('.tips').show();})});}}}]).directive('rename',function(){return{restrict:'C',link:function($scope,element){element.bind('click',function(){var did=$(this).attr('data-did');$('.re-name').attr('data-did',did);$('.rename-device').show();$('#newName')[0].value=$(this).attr('data-name');})}}}).directive('renameGroup',function(){return{restrict:'C',link:function($scope,element){element.bind('click',function(){var gname=$(this).attr('data-Gname');$('.new-group').show();$('.re-gName').attr('data-gname',gname);$('#newGname')[0].value=gname;})}}}).directive('delGroup',function(){return{restrict:'C',link:function($scope,element){element.bind('click',function(){var gname=$(this).attr('data-Gname');$('.delete-group').show();$('.delete').attr('data-gname',gname);})}}}).factory('publicData',function(){var public={};public.tempGroup=[];public.setTemp=function(data){return public.tempGroup=data;};public.total=[];public.setData=function(data){return public.total=data;};return public;}).factory('conversion',function(){return{dateChange:function(date){var date=new Date(date);var Y=date.getFullYear()+'-';var M=(date.getMonth()+1<10?'0'+(date.getMonth()+1):date.getMonth()+1)+'-';var D=(date.getDate()<10?'0'+(date.getDate()):date.getDate())+' ';var h=(date.getHours()<10?'0'+(date.getHours()):date.getHours())+':';var m=(date.getMinutes()<10?'0'+(date.getMinutes()):date.getMinutes())+':';var s=(date.getSeconds()<10?'0'+(date.getSeconds()):date.getSeconds());return date=(Y+M+D+h+m+s);},dateTransform:function(date){var today=new Date();var timeDif=0;var timeZone=today.getTimezoneOffset()/60;timeDif=timeZone*3600000;var realTime=Date.parse(date)+timeDif;return realTime=this.dateChange(realTime);},dataToLoc:function(date){var today=new Date();var timeDif=0;var timeZone=today.getTimezoneOffset()/60;timeDif=timeZone*3600000;var realTime=Date.parse(date)-timeDif;return realTime=this.dateChange(realTime);}}}).factory('playback',['conversion',function(conversion){var playback={};var LAT;var LNG;var LBSLAT;var LBSLNG;function getDistance(lat1,lng1,lat2,lng2){var dValueLat=(lat1>lat2)?(lat1-lat2):(lat2-lat1);var dValueLng=(lng1>lng2)?(lng1-lng2):(lng2-lng1);if((0.0000001>dValueLat)&&(0.0000001>dValueLng)){return 0.0;}lng1*=Math.PI/180.0;lat1*=Math.PI/180.0;lng2*=Math.PI/180.0;lat2*=Math.PI/180.0;var sDistance=Math.acos(Math.cos(lat1-lat2)-Math.cos(lat1)*Math.cos(lat2)*(1-Math.cos(lng1-lng2)));sDistance+=sDistance*6378137.0;return sDistance;}function timeCycle(msd){if(msd!=0){var time=parseFloat(msd)/1000;if(null!=time&&""!=time){if(time>=60&&time<60*60){time=parseInt(time/60.0)+"分钟"+parseInt((parseFloat(time/60.0)-parseInt(time/60.0))*60)+"秒";}else if(time>=60*60&&time<60*60*24){time=parseInt(time/3600.0)+"小时"+parseInt((parseFloat(time/3600.0)-parseInt(time/3600.0))*60)+"分钟"+parseInt((parseFloat((parseFloat(time/3600.0)-parseInt(time/3600.0))*60)-parseInt((parseFloat(time/3600.0)-parseInt(time/3600.0))*60))*60)+"秒";}else if(time>0&&time<60){time=parseInt(time)+"秒";}else{time=parseInt(time/86400.0)+"天"+parseInt((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)+"小时"+parseInt(((parseFloat((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)-parseInt((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)))*60)+"分钟"+parseInt((parseFloat(((parseFloat((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)-parseInt((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)))*60)-parseInt(((parseFloat((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)-parseInt((parseFloat(time/86400.0)-parseInt(time/86400.0))*24)))*60))*60)+"秒";}}}else{time=0+'秒';}return time;};function getTime(s1,s2){var time=Date.parse(s1.GpsT.replace(/-/g,'/'))-Date.parse(s2.GpsT.replace(/-/g,'/'));var dt=time;dt>0?dt=time:dt=-time;return dt/3600000;}function getSpeed(s1,s2){var d=getDistance(s1[LAT],s1[LNG],s2[LAT],s2[LNG]);var dis=d/1000;var dt=getTime(s1,s2);return dis/dt;}function getLBSspeed(s1,s2){var d=getDistance(s1[LAT],s1[LNG],s2.lbslat,s2.lbslng);var dis=isNaN(d)?0:d;var dt=getTime(s1,s2);return dis/dt;}function clone(obj){var objClone;if(obj.constructor==Object){objClone=new obj.constructor();}else{objClone=new obj.constructor(obj.valueOf());}for(var key in obj){if(objClone[key]!=obj[key]){if(typeof(obj[key])=='object'){objClone[key]=obj[key].Clone();}else{objClone[key]=obj[key];}}}objClone.toString=obj.toString;objClone.valueOf=obj.valueOf;return objClone;}function playBackSplitSharpPoint(dataArray){var index;var temp;for(index=0;index<1;index++){temp=playBackSplitPoint(dataArray,1);}for(index=0;index<1;index++){temp=playBackSmpaleSplitPoint(temp);}return temp;}function isSharp(x1,y1,x2,y2,x3,y3,c){var d12,dx12,dy12;var d23,dx23,dy23;var d31,dx31,dy31;var a1,a2;dx12=x1-x2;dx23=x2-x3;dx31=x3-x1;dy12=y1-y2;dy23=y2-y3;dy31=y3-y1;d12=dx12*dx12+dy12*dy12;d23=dx23*dx23+dy23*dy23;d31=dx31*dx31+dy31*dy31;a1=d12+d23-d31;if(a1<=0)return false;a1=a1*a1;a2=d12*d23*c;if(a1>a2)return true;return false;}function playBackSplitPoint(m_lstRecordSplit_tmp,turn){var a,b,c;var index;var temp=[];temp.push(m_lstRecordSplit_tmp[0]);for(index=0;index<m_lstRecordSplit_tmp.length;index++){if((index+2)<m_lstRecordSplit_tmp.length){a=m_lstRecordSplit_tmp[index];b=m_lstRecordSplit_tmp[index+1];c=m_lstRecordSplit_tmp[index+2];if(isSharp(a[LNG],a[LAT],b[LNG],b[LAT],c[LNG],c[LAT],turn)){continue;}temp.push(b);}else{if(m_lstRecordSplit_tmp[index+1])temp.push(m_lstRecordSplit_tmp[index+1]);}}return temp;}function playBackSmpaleSplitPoint(m_lstRecordSplit_tmp){var tmIndex;var tmLast;var dis=0;var index;var temp=[];tmLast=m_lstRecordSplit_tmp[0];for(index=1;index<m_lstRecordSplit_tmp.length;index++){tmIndex=m_lstRecordSplit_tmp[index];var s=getDistance(tmLast[LAT],tmLast[LNG],tmIndex[LAT],tmIndex[LNG]);tmLast=tmIndex;if(s<10*dis){temp.push(tmIndex)}dis=s;}return temp;}playback.filter=function(data,mapType){function playBackDelpFristPoint(){var tags=last.GpsS;var tempDate=[];for(var i=data_i+1;i<getedData.length;i++){var intags=getedData[i].GpsS;if(intags!=tags){if((i+2)<getedData.length){if(intags=='W'){getedData[i-1].isAbnormal=true;tags=getedData[i].GpsS;}else{getedData[i].isAbnormal=true;i++;tags=getedData[i].GpsS;}}}}var _last=last;tempDate.push(getedData[data_i]);for(var i=data_i+1;i<getedData.length;i++){var pt=getedData[i];if(getedData[i].isAbnormal){tempDate.push(pt);continue;}var s=getDistance(_last[LAT],_last[LNG],pt[LAT],pt[LNG]);if(s<5){getedData[i].isAbnormal=true;tempDate.push(pt);continue;}tempDate.push(pt);_last=pt;}getedData=tempDate;}LAT='b_lat';LNG='b_lng';LBSLAT='lbs_blat';LBSLNG='lbs_blng';var getedData=data.datas;var finalData=[];var pbData={};var section_gap=600000;pbData.usefulldata=[];pbData.section=[];pbData.secData=[];pbData.secDataCy=[];pbData.totalData=[];for(var i=0;i<getedData.length;i++){if(data.pbtype!=4){getedData[i].GpsT=conversion.dataToLoc(getedData[i].GpsT.replace(/-/g,'/'));if(getedData[i].GpsS!="W"&&(getedData[i][LNG]==0&&getedData[i][LAT]==0)){getedData.splice(i,1);i--;}}else{getedData[i].GpsT=conversion.dataToLoc(getedData[i].time.replace(/-/g,'/'));if(getedData[i][LNG]==0&&getedData[i][LAT]==0){getedData.splice(i,1);i--;}}}if(getedData.length==0)return pbData;var data_i=0;if(getedData.length>=8){while(true){var find_s=data_i;var find_v=0;var piont1=getedData[find_s++];var piont2=getedData[find_s++];var piont3=getedData[find_s++];var piont4=getedData[find_s++];var spd1=getSpeed(piont1,piont2);var spd2=getSpeed(piont1,piont3);var spd3=getSpeed(piont1,piont4);if(spd1<360)find_v++;if(spd2<360)find_v++;if(spd3<360)find_v++;if(find_v>=2){break;}else{data_i++;if(getedData.length-data_i<4)break;}}}finalData.push(getedData[data_i]);var last=getedData[data_i];var temp=null;var pt={};if(data.pbtype=='1'){playBackDelpFristPoint();for(var i=data_i+1;i<getedData.length;i++){pt=getedData[i];var spd=getSpeed(last,pt);if(spd>360){pt.isAbnormal=true;continue;}if((pt['GpsS']!='G'&&pt['GpsS']!='A')){temp=pt;continue;}if(pt[LAT]==last[LAT]&&pt[LNG]==last[LNG]){temp=pt;continue;}if(temp){var first=clone(last);first.GpsT=temp.GpsT;first.GpsS=temp.GpsS;finalData.push(first);finalData.push(pt);temp=null;}else{finalData.push(pt);}last=pt;}finalData=playBackSplitSharpPoint(finalData);}else if(data.pbtype=='2'){playBackDelpFristPoint();section_gap=1200000;for(var i=data_i+1;i<getedData.length;i++){pt=getedData[i];if(((pt[LAT]==0)&&(pt[LNG]==0))||pt.isAbnormal)continue;var last_time=new Date(last.GpsT.replace(/-/g,'/')).getTime()/1000;var pt_time=new Date(pt.GpsT.replace(/-/g,'/')).getTime()/1000;var _t=pt_time-last_time;if(_t>1800){temp=pt;}if(temp!=null){var first=clone(last);first.GpsT=temp.GpsT;first.GpsS=pt.GpsS;finalData.push(first);finalData.push(pt);temp=null;}else{finalData.push(pt);}last=pt;}finalData=playBackSplitSharpPoint(finalData);}else if(data.pbtype=='3'){for(var i=data_i+1;i<getedData.length;i++){pt=getedData[i];var spd=getSpeed(last,pt);if(spd>360){continue;}finalData.push(pt);last=pt;}}else if(data.pbtype=='4'){for(var i=data_i+1;i<getedData.length;i++){pt=getedData[i];var spd=getSpeed(last,pt);if(spd>360){var confirm_i=i-2;if(getedData[confirm_i]){var confirmSpeed=getSpeed(getedData[confirm_i],pt);if(confirmSpeed>360){continue}else{finalData[finalData.length-1][LAT]=pt[LAT];finalData[finalData.length-1][LNG]=pt[LNG];}}else{continue;}}finalData.push(pt);last=pt;}}if(data.pbtype!='4'){for(var i=0;i<finalData.length-1;i++){if(Date.parse(finalData[i+1].GpsT)-Date.parse(finalData[i].GpsT)>section_gap){var sec=finalData.splice(0,i+1);if(i>1)pbData.section.push(sec);i=0;}}if(finalData.length>1)pbData.section.push(finalData);if(pbData.section.length==0)return{};}else{for(var i=0;i<finalData.length-1;i++){if(finalData[i].state=='STP'||finalData[i].state=='VIB'){var _eTime=new Date(finalData[i].GpsT.replace(/-/g,'/'));var _sTime=new Date(finalData[0].GpsT.replace(/-/g,'/'));var sec=finalData.splice(0,i+1);var secLength=pbData.section.length;if((i<2||_eTime-_sTime<600000)&&secLength>0){pbData.section[secLength-1]=pbData.section[secLength-1].concat(sec);}else{pbData.section.push(sec);}i=0;}}if(finalData.length>1)pbData.section.push(finalData);if(pbData.section.length==0)return{};}var secMileages=[];var secStartTime=[],secEndTime=[];var drvingTime=[];var cyDrvingTime=[];var aveSpeed=[];var stayTime=[];var cyStayTime=[];var dist=0;var st=pbData.section[0][0].GpsT;var et=pbData.section[pbData.section.length-1][pbData.section[pbData.section.length-1].length-1].GpsT;var drvingTTime=0;var stayTTime=0;pbData.usefulldata=[];for(var i=0;i<pbData.section.length;){var secMileage=0;for(var j=0;j<pbData.section[i].length-1;j++){secMileage+=getDistance(pbData.section[i][j][LAT],pbData.section[i][j][LNG],pbData.section[i][j+1][LAT],pbData.section[i][j+1][LNG]);}if((data.pbtype!=3&&data.pbtype!=4)&&secMileage<150){pbData.section.splice(i,1);continue;}dist+=secMileage;secMileage=secMileage/1000;secMileages.push(secMileage);secStartTime.push(pbData.section[i][0].GpsT);secEndTime.push(pbData.section[i][pbData.section[i].length-1].GpsT);var drv=(Date.parse(secEndTime[i])-Date.parse(secStartTime[i]));drvingTime.push(drv);drvingTTime+=drv;cyDrvingTime.push(timeCycle(drv));var ave=secMileages[i]/drvingTime[i]*3600000;aveSpeed.push(ave);var stay;if(i+1>=pbData.section.length){stay=0;}else{stay=(Date.parse(pbData.section[i+1][0].GpsT)-Date.parse(pbData.section[i][pbData.section[i].length-1].GpsT));}stayTime.push(stay);cyStayTime.push(timeCycle(stay));stayTTime+=stay;pbData.usefulldata=pbData.usefulldata.concat(pbData.section[i]);i++}pbData.secDataCy.push(secStartTime);pbData.secDataCy.push(secEndTime);pbData.secDataCy.push(cyDrvingTime);pbData.secDataCy.push(cyStayTime);pbData.secDataCy.push(secMileages);pbData.secDataCy.push(aveSpeed);pbData.secData.push(secStartTime);pbData.secData.push(secEndTime);pbData.secData.push(drvingTime);pbData.secData.push(stayTime);pbData.secData.push(secMileages);pbData.secData.push(aveSpeed);pbData.sec_Datas=[];for(var i=0;i<secStartTime.length;i++){var sections=[];sections.push(secStartTime[i]);sections.push(secEndTime[i]);sections.push(cyDrvingTime[i]);sections.push(cyStayTime[i]);sections.push(secMileages[i]);sections.push(aveSpeed[i]);pbData.sec_Datas.push(sections);}var aveTSpeed=dist/drvingTTime*3600;drvingTTime=timeCycle(drvingTTime);stayTTime=timeCycle(stayTTime);pbData.totalData.push(st);pbData.totalData.push(et);pbData.totalData.push(drvingTTime);pbData.totalData.push(stayTTime);pbData.totalData.push(dist);pbData.totalData.push(aveTSpeed);return pbData;};return playback;}]);